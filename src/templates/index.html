<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kizuna Memory - å›æƒ³ç™‚æ³•ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* é«˜é½¢è€…å‘ã‘ã®UIã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-size: 18px;
            line-height: 1.6;
        }
        .large-text {
            font-size: 20px;
        }
        .extra-large-text {
            font-size: 24px;
        }
        .large-button {
            padding: 16px 24px;
            font-size: 18px;
            min-height: 60px;
        }
        .story-text {
            font-size: 20px;
            line-height: 1.8;
        }
        .highlight {
            background-color: #fef3c7;
            padding: 2px 4px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen py-8">
    <div class="container mx-auto px-4">
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-5xl mx-auto">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">ğŸŒ¸ Kizuna Memory ğŸŒ¸</h1>
                <p class="text-xl text-gray-600">ã‚ãªãŸã®å¤§åˆ‡ãªæ€ã„å‡ºã‚’ã€å¿ƒæ¸©ã¾ã‚‹ç‰©èªã«</p>
                <div id="storyCount" class="mt-4 text-lg text-blue-600 font-semibold"></div>
            </div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="flex flex-wrap justify-center mb-8 border-b">
                <button id="tab-create" class="tab-button px-6 py-3 text-lg font-semibold border-b-2 border-blue-500 text-blue-600">
                    âœï¸ æ–°ã—ã„ç‰©èªã‚’ä½œã‚‹
                </button>
                <button id="tab-history" class="tab-button px-6 py-3 text-lg font-semibold text-gray-500 hover:text-gray-700">
                    ğŸ“š ã“ã‚Œã¾ã§ã®ç‰©èª
                </button>
            </div>

            <!-- æ–°ã—ã„ç‰©èªä½œæˆã‚¿ãƒ– -->
            <div id="create-tab" class="tab-content">
                <!-- ã‚«ãƒ†ã‚´ãƒªé¸æŠ -->
                <div class="mb-8">
                    <label class="block text-gray-700 text-xl font-bold mb-4">ğŸ’­ ã©ã‚“ãªæ€ã„å‡ºã«ã¤ã„ã¦è©±ã—ã¾ã™ã‹ï¼Ÿ</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button class="category-btn bg-pink-100 hover:bg-pink-200 p-4 rounded-lg border-2 border-transparent hover:border-pink-300 transition-all" data-category="childhood">
                            <div class="text-3xl mb-2">ğŸ§¸</div>
                            <div class="large-text font-semibold">å¹¼å°‘æœŸã®æ€ã„å‡º</div>
                        </button>
                        <button class="category-btn bg-green-100 hover:bg-green-200 p-4 rounded-lg border-2 border-transparent hover:border-green-300 transition-all" data-category="school">
                            <div class="text-3xl mb-2">ğŸ“</div>
                            <div class="large-text font-semibold">å­¦ç”Ÿæ™‚ä»£ã®å‡ºæ¥äº‹</div>
                        </button>
                        <button class="category-btn bg-blue-100 hover:bg-blue-200 p-4 rounded-lg border-2 border-transparent hover:border-blue-300 transition-all" data-category="work">
                            <div class="text-3xl mb-2">ğŸ’¼</div>
                            <div class="large-text font-semibold">ä»•äº‹ã§ã®çµŒé¨“</div>
                        </button>
                        <button class="category-btn bg-yellow-100 hover:bg-yellow-200 p-4 rounded-lg border-2 border-transparent hover:border-yellow-300 transition-all" data-category="family">
                            <div class="text-3xl mb-2">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                            <div class="large-text font-semibold">å®¶æ—ã¨ã®æ™‚é–“</div>
                        </button>
                        <button class="category-btn bg-purple-100 hover:bg-purple-200 p-4 rounded-lg border-2 border-transparent hover:border-purple-300 transition-all" data-category="hobbies">
                            <div class="text-3xl mb-2">ğŸ¨</div>
                            <div class="large-text font-semibold">è¶£å‘³ã‚„ç‰¹æŠ€</div>
                        </button>
                        <button class="category-btn bg-gray-100 hover:bg-gray-200 p-4 rounded-lg border-2 border-transparent hover:border-gray-300 transition-all" data-category="general">
                            <div class="text-3xl mb-2">ğŸ’«</div>
                            <div class="large-text font-semibold">è‡ªç”±ã«è©±ã™</div>
                        </button>
                    </div>
                </div>

                <!-- è³ªå•ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤º -->
                <div id="promptSection" class="mb-6 hidden">
                    <div class="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-400">
                        <h3 class="text-xl font-semibold text-blue-800 mb-3">ğŸ’¡ ã“ã‚“ãªã“ã¨ã‚’æ€ã„å‡ºã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</h3>
                        <div id="promptText" class="large-text text-blue-700 mb-4"></div>
                        <button id="changePrompt" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                            åˆ¥ã®è³ªå•ã‚’è¦‹ã‚‹
                        </button>
                    </div>
                </div>

                <!-- è¨˜æ†¶å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="mb-6">
                    <label for="memoryInput" class="block text-gray-700 text-xl font-bold mb-4">ğŸ“ æ€ã„å‡ºã‚’èã‹ã›ã¦ãã ã•ã„ï¼š</label>
                    <textarea id="memoryInput" class="shadow-lg border-2 border-gray-200 rounded-lg w-full py-4 px-6 text-gray-700 leading-relaxed focus:outline-none focus:border-blue-400 focus:shadow-xl h-40 large-text" placeholder="ã“ã“ã«æ€ã„å‡ºã‚’è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„ã€‚ã©ã‚“ãªå°ã•ãªã“ã¨ã§ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚"></textarea>
                </div>

                <!-- éŸ³å£°éŒ²éŸ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="mb-6">
                    <label class="block text-gray-700 text-xl font-bold mb-4">ğŸ¤ éŸ³å£°ã§æ€ã„å‡ºã‚’è©±ã™ï¼ˆä»»æ„ï¼‰ï¼š</label>
                    <div class="bg-orange-50 p-6 rounded-lg border-2 border-orange-200">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <button id="recordBtn" class="large-button bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg focus:outline-none focus:shadow-xl transition-all">
                                ğŸ¤ éŒ²éŸ³é–‹å§‹
                            </button>
                            <button id="stopRecordBtn" class="large-button bg-gray-500 text-white font-bold rounded-lg focus:outline-none focus:shadow-xl transition-all" disabled>
                                â¹ï¸ éŒ²éŸ³åœæ­¢
                            </button>
                            <span id="recordingStatus" class="large-text text-gray-600"></span>
                        </div>
                        <div id="audioPreview" class="hidden">
                            <audio id="recordedAudio" controls class="w-full"></audio>
                        </div>
                    </div>
                </div>

                <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="mb-6">
                    <label for="imageInput" class="block text-gray-700 text-xl font-bold mb-4">ğŸ“· æ€ã„å‡ºã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰ï¼š</label>
                    <div class="bg-green-50 p-6 rounded-lg border-2 border-green-200">
                        <input type="file" id="imageInput" accept="image/*" class="shadow border rounded-lg py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-xl large-text w-full">
                        <div id="imagePreview" class="mt-4 hidden">
                            <img id="previewImg" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" class="max-w-sm max-h-64 rounded-lg shadow-md mx-auto">
                        </div>
                    </div>
                </div>

                <!-- ç‰©èªç”Ÿæˆãƒœã‚¿ãƒ³ -->
                <div class="flex justify-center mb-8">
                    <button id="generateStoryBtn" class="large-button bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold rounded-xl focus:outline-none focus:shadow-xl transform hover:scale-105 transition-all">
                        âœ¨ å¿ƒæ¸©ã¾ã‚‹ç‰©èªã‚’ä½œã‚‹ âœ¨
                    </button>
                </div>

                <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
                <div id="loadingIndicator" class="text-center text-blue-500 extra-large-text hidden mb-6">
                    <div class="animate-pulse">ğŸŒŸ ç´ æ•µãªç‰©èªã‚’ä½œæˆä¸­... ğŸŒŸ</div>
                </div>

                <!-- ç‰©èªå‡ºåŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div id="storyOutput" class="bg-gradient-to-br from-yellow-50 to-orange-50 p-8 rounded-xl border-2 border-yellow-200 shadow-lg min-h-[200px]">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">ğŸ“– ã‚ãªãŸã®ç‰©èª</h2>
                        <div class="flex flex-wrap gap-3">
                            <button id="playStoryBtn" class="large-button bg-purple-500 hover:bg-purple-600 text-white font-bold rounded-lg focus:outline-none focus:shadow-xl hidden transition-all">
                                ğŸ”Š éŸ³å£°ã§èã
                            </button>
                            <button id="continueStoryBtn" class="large-button bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg focus:outline-none focus:shadow-xl hidden transition-all">
                                ğŸ“ ç¶šãã‚’ä½œã‚‹
                            </button>
                        </div>
                    </div>
                    <div id="storyText" class="story-text text-gray-700 whitespace-pre-wrap leading-relaxed"></div>
                    <div id="extractedMemory" class="mt-6 p-4 bg-blue-50 rounded-lg hidden">
                        <h3 class="text-lg font-semibold text-blue-800 mb-2">ğŸ¤ éŸ³å£°ã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸè¨˜æ†¶:</h3>
                        <p id="extractedMemoryText" class="large-text text-blue-700"></p>
                    </div>
                    <div id="audioPlayer" class="mt-6 hidden">
                        <audio id="storyAudio" controls class="w-full"></audio>
                    </div>
                    <div id="continuationSection" class="mt-6 hidden">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">ğŸ“š ç‰©èªã®ç¶šããƒ»åˆ¥ã®è¦–ç‚¹</h3>
                        <div class="flex flex-wrap gap-3 mb-4">
                            <button class="continuation-btn large-button bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg" data-type="continue">
                                â¡ï¸ ç¶šãã‚’èª­ã‚€
                            </button>
                            <button class="continuation-btn large-button bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-lg" data-type="alternative">
                                ğŸ”„ åˆ¥ã®å±•é–‹
                            </button>
                            <button class="continuation-btn large-button bg-pink-500 hover:bg-pink-600 text-white font-bold rounded-lg" data-type="perspective">
                                ğŸ‘ï¸ åˆ¥ã®è¦–ç‚¹
                            </button>
                        </div>
                        <div id="continuationText" class="story-text text-gray-700 whitespace-pre-wrap leading-relaxed bg-white p-6 rounded-lg border-2 border-gray-200"></div>
                    </div>
                </div>

                <!-- åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div id="encouragementMessage" class="mt-6 p-6 bg-gradient-to-r from-pink-100 to-purple-100 rounded-xl border-2 border-pink-200 text-center hidden">
                    <div class="text-2xl mb-2">ğŸŒŸ</div>
                    <div id="encouragementText" class="large-text text-purple-700 font-semibold"></div>
                </div>
            </div>

            <!-- ç‰©èªå±¥æ­´ã‚¿ãƒ– -->
            <div id="history-tab" class="tab-content hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“š ã“ã‚Œã¾ã§ã®ç‰©èª</h2>
                    <p class="large-text text-gray-600">ã‚ãªãŸãŒä½œã£ãŸç´ æ•µãªç‰©èªãŸã¡ã§ã™</p>
                </div>
                <div id="storiesContainer" class="space-y-6">
                    <!-- ç‰©èªã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedImageData = null;
        let recordedAudioData = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let currentStoryId = null;
        let selectedCategory = 'general';
        let currentPrompts = [];
        let allStories = []; // ç‰©èªå±¥æ­´å…¨ä½“ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let currentPromptIndex = 0;

        // Pythonã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ã¦ã„ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæƒ…å ±ã‚’ã“ã“ã«ç›´æ¥å®šç¾©
        const REMINISCENCE_PROMPTS = {
            "childhood": {
                "name": "å¹¼å°‘æœŸã®æ€ã„å‡º",
                "prompts": [
                    "å°å­¦æ ¡ã®é‹å‹•ä¼šã§ä¸€ç•ªå°è±¡ã«æ®‹ã£ã¦ã„ã‚‹ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ",
                    "å­ä¾›ã®é ƒã€ä¸€ç•ªå¥½ãã ã£ãŸéŠã³ã¯ä½•ã§ã—ãŸã‹ï¼Ÿ",
                    "å®¶æ—ã¨ä¸€ç·’ã«è¡Œã£ãŸæ—…è¡Œã§è¦šãˆã¦ã„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "åˆã‚ã¦è‡ªè»¢è»Šã«ä¹—ã‚ŒãŸæ™‚ã®ã“ã¨ã‚’è¦šãˆã¦ã„ã¾ã™ã‹ï¼Ÿ",
                    "å­ä¾›ã®é ƒã®å¤ä¼‘ã¿ã®æ€ã„å‡ºã‚’æ•™ãˆã¦ãã ã•ã„ã€‚"
                ]
            },
            "school": {
                "name": "å­¦ç”Ÿæ™‚ä»£ã®å‡ºæ¥äº‹",
                "prompts": [
                    "å­¦ç”Ÿæ™‚ä»£ã®ä¸€ç•ªã®å‹é”ã¨ã®æ€ã„å‡ºã¯ä½•ã§ã™ã‹ï¼Ÿ",
                    "éƒ¨æ´»å‹•ã‚„èª²å¤–æ´»å‹•ã§å°è±¡ã«æ®‹ã£ã¦ã„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "å­¦æ ¡ã®å…ˆç”Ÿã§ç‰¹ã«å°è±¡ã«æ®‹ã£ã¦ã„ã‚‹æ–¹ã¯ã„ã¾ã™ã‹ï¼Ÿ",
                    "æ–‡åŒ–ç¥­ã‚„ä½“è‚²ç¥­ã§ã®æ€ã„å‡ºã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
                    "åˆæ‹ã®æ€ã„å‡ºã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"
                ]
            },
            "work": {
                "name": "ä»•äº‹ã§ã®çµŒé¨“",
                "prompts": [
                    "åˆã‚ã¦ã®çµ¦æ–™ã§ä½•ã‚’è²·ã„ã¾ã—ãŸã‹ï¼Ÿ",
                    "ä»•äº‹ã§ä¸€ç•ªã‚„ã‚ŠãŒã„ã‚’æ„Ÿã˜ãŸç¬é–“ã¯ã„ã¤ã§ã™ã‹ï¼Ÿ",
                    "è·å ´ã®åŒåƒšã¨ã®æ€ã„å‡ºã§å°è±¡ã«æ®‹ã£ã¦ã„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "ä»•äº‹ã§å¤§ããªæˆåŠŸã‚’åã‚ãŸæ™‚ã®ã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
                    "è»¢è·ã‚„æ˜‡é€²ã®æ™‚ã®æ°—æŒã¡ã‚’è¦šãˆã¦ã„ã¾ã™ã‹ï¼Ÿ"
                ]
            },
            "family": {
                "name": "å®¶æ—ã¨ã®æ™‚é–“",
                "prompts": [
                    "çµå©šå¼ã®æ—¥ã®ã“ã¨ã‚’è¦šãˆã¦ã„ã¾ã™ã‹ï¼Ÿ",
                    "ãŠå­ã•ã‚“ãŒç”Ÿã¾ã‚ŒãŸæ™‚ã®æ°—æŒã¡ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
                    "å®¶æ—ã§éã”ã—ãŸç‰¹åˆ¥ãªè¨˜å¿µæ—¥ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "ãŠå­«ã•ã‚“ã¨ã®æ€ã„å‡ºã§å°è±¡ã«æ®‹ã£ã¦ã„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "å®¶æ—ã¿ã‚“ãªã§ç¬‘ã£ãŸæ¥½ã—ã„å‡ºæ¥äº‹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"
                ]
            },
            "hobbies": {
                "name": "è¶£å‘³ã‚„ç‰¹æŠ€",
                "prompts": [
                    "ä¸€ç•ªç†±ä¸­ã—ãŸè¶£å‘³ã¯ä½•ã§ã—ãŸã‹ï¼Ÿ",
                    "æ–™ç†ã§å¾—æ„ã ã£ãŸï¼ˆå¾—æ„ãªï¼‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "ã‚¹ãƒãƒ¼ãƒ„ã‚„é‹å‹•ã§æ¥½ã—ã‹ã£ãŸæ€ã„å‡ºã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "æ‰‹ä½œã‚Šã§ä½•ã‹ã‚’ä½œã£ãŸæ€ã„å‡ºã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "éŸ³æ¥½ã‚„èŠ¸è¡“ã§å¿ƒã«æ®‹ã£ã¦ã„ã‚‹ä½“é¨“ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"
                ]
            }
        };

        // åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const encouragementMessages = [
            "ç´ æ™´ã‚‰ã—ã„æ€ã„å‡ºã§ã™ã­ï¼âœ¨",
            "ã¾ãŸä¸€ã¤å¤§åˆ‡ãªè¨˜æ†¶ãŒå½¢ã«ãªã‚Šã¾ã—ãŸã­ ğŸŒ¸",
            "å¿ƒæ¸©ã¾ã‚‹ç‰©èªã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸ’•",
            "ã‚ãªãŸã®äººç”Ÿã®å®ç‰©ãŒç‰©èªã«ãªã‚Šã¾ã—ãŸ ğŸ’",
            "ç´ æ•µãªæ€ã„å‡ºã‚’åˆ†ã‹ã¡åˆã£ã¦ãã ã•ã‚Šã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸ™"
        ];

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadStoryCount();
            loadStoryHistory();
            setupTabNavigation();
            setupCategorySelection();
            setupAudioRecording();
            setupImageUpload();
            setupStoryGeneration();
        });

        // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        function setupTabNavigation() {
            document.getElementById('tab-create').addEventListener('click', () => {
                showTab('create');
            });
            document.getElementById('tab-history').addEventListener('click', () => {
                showTab('history');
                loadStoryHistory();
            });
        }

        function showTab(tabName) {
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('text-gray-500');
            });
            document.getElementById(`tab-${tabName}`).classList.add('border-blue-500', 'text-blue-600');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-500');

            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        }

        // ã‚«ãƒ†ã‚´ãƒªé¸æŠ
        function setupCategorySelection() {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    // é¸æŠçŠ¶æ…‹ã®æ›´æ–°
                    document.querySelectorAll('.category-btn').forEach(b => {
                        b.classList.remove('ring-4', 'ring-blue-300');
                    });
                    btn.classList.add('ring-4', 'ring-blue-300');

                    selectedCategory = btn.dataset.category;
                    
                    if (selectedCategory !== 'general') {
                        loadPrompts(selectedCategory);
                        showPromptSection();
                    } else {
                        hidePromptSection();
                    }
                });
            });

            document.getElementById('changePrompt').addEventListener('click', () => {
                showNextPrompt();
            });
        }

        // APIé€šä¿¡ã®ä»£ã‚ã‚Šã«ã€ä¸Šã§å®šç¾©ã—ãŸJavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚€
        function loadPrompts(category) {
            if (REMINISCENCE_PROMPTS[category]) {
                currentPrompts = REMINISCENCE_PROMPTS[category].prompts;
                currentPromptIndex = 0;
                showCurrentPrompt();
            } else {
                console.error('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚«ãƒ†ã‚´ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', category);
            }
        }

        function showPromptSection() {
            document.getElementById('promptSection').classList.remove('hidden');
        }

        function hidePromptSection() {
            document.getElementById('promptSection').classList.add('hidden');
        }

        function showCurrentPrompt() {
            if (currentPrompts.length > 0) {
                document.getElementById('promptText').textContent = currentPrompts[currentPromptIndex];
            }
        }

        function showNextPrompt() {
            if (currentPrompts.length > 0) {
                currentPromptIndex = (currentPromptIndex + 1) % currentPrompts.length;
                showCurrentPrompt();
            }
        }

        // ç‰©èªæ•°ã®èª­ã¿è¾¼ã¿
        async function loadStoryCount() {
            try {
                const response = await fetch('/api/get_stories');
                const stories = await response.json();
                if (response.ok) {
                    const count = stories.length;
                    document.getElementById('storyCount').textContent = 
                        count > 0 ? `ã“ã‚Œã¾ã§ã« ${count} å€‹ã®ç‰©èªã‚’ä½œã‚Šã¾ã—ãŸ ğŸŒŸ` : '';
                }
            } catch (error) {
                console.error('ç‰©èªæ•°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ç‰©èªå±¥æ­´ã®èª­ã¿è¾¼ã¿
        async function loadStoryHistory() {
            try {
                const response = await fetch('/api/get_stories');
                if (!response.ok) {
                    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã€ã‚µãƒ³ãƒ—ãƒ«ã‚’è¡¨ç¤º
                    throw new Error('Failed to fetch stories from API');
                }
                const stories = await response.json();
                allStories = stories; // å–å¾—ã—ãŸç‰©èªã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                displayStoryHistory(stories);
            } catch (error) {
                console.warn('ç‰©èªå±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚', error);
                displaySampleStory();
            }
        }

        function displaySampleStory() {
            const sampleStory = {
                id: 'sample-hikari-no-byoto',
                created_at: new Date().toISOString(),
                memory_text: 'ç—…é™¢ã®çª“ã‹ã‚‰è¦‹ãŸæ™¯è‰²ã®æ€ã„å‡ºã€‚',
                story: 'ã²ã‹ã‚Šã¯ã€ç—…å®¤ã®çª“ã‹ã‚‰å¤–ã‚’çœºã‚ã‚‹ã®ãŒæ—¥èª²ã§ã—ãŸã€‚ç©ºã®è‰²ã€é›²ã®å½¢ã€é ãã®è¡—ã®ã¾ãŸãŸãã€‚å°ã•ãªçª“ã¯ã€å½¼å¥³ã«ã¨ã£ã¦ä¸–ç•Œã¨ã¤ãªãŒã‚‹å¤§ããªã‚­ãƒ£ãƒ³ãƒã‚¹ã§ã—ãŸã€‚ã‚ã‚‹æ—¥ã€å‘ã‹ã„ã®ãƒ“ãƒ«ã®çª“ã«ã€åŒã˜ã‚ˆã†ã«å¤–ã‚’çœºã‚ã‚‹ç”·ã®å­ã®å§¿ã‚’è¦‹ã¤ã‘ã¾ã™ã€‚...',
                has_image: true,
                has_audio: false,
                image_path: 'images/sample_story_image.png', // ç”»åƒã¸ã®ãƒ‘ã‚¹
                is_sample: true // ã‚µãƒ³ãƒ—ãƒ«ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
            };
            displayStoryHistory([sampleStory]);
        }

        function displayStoryHistory(stories) {
            const container = document.getElementById('storiesContainer');
            if (stories.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">ğŸ“</div>
                        <p class="large-text text-gray-500">ã¾ã ç‰©èªãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                        <p class="text-gray-400">ã€Œæ–°ã—ã„ç‰©èªã‚’ä½œã‚‹ã€ã‚¿ãƒ–ã‹ã‚‰å§‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†</p>
                    </div>
                `;
                return;
           }

            container.innerHTML = stories.map(story => {
                const buttonHtml = story.is_sample
                    ? `<a href="storybook_sample.html" target="_blank" rel="noopener noreferrer" class="mt-4 inline-block bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg transition-all font-semibold">çµµæœ¬ã‚’è¦‹ã‚‹ ğŸ“–</a>`
                    : `<button onclick="showFullStory('${story.id}')" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all">å…¨æ–‡ã‚’èª­ã‚€</button>`;

                const imageHtml = story.image_path
                    ? `<div class="my-4"><img src="${story.image_path}" alt="ç‰©èªã®ç”»åƒ" class="rounded-lg shadow-md w-full max-w-xs h-auto mx-auto block"></div>`
                    : '';

                const memoryTextHtml = story.memory_text
                    ? `<div class="mb-4 p-3 bg-gray-50 rounded-lg"><div class="text-sm font-semibold text-gray-600 mb-1">ã‚ãªãŸã®è¨˜æ†¶:</div><div class="text-gray-700">${story.memory_text.substring(0, 100)}${story.memory_text.length > 100 ? '...' : ''}</div></div>`
                    : '';

                return `
                <div class="bg-white p-6 rounded-xl shadow-md border-2 border-gray-100 hover:border-blue-200 transition-all">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="text-sm text-gray-500 mb-2">
                                ${new Date(story.created_at).toLocaleDateString('ja-JP')} 
                                ${new Date(story.created_at).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}
                            </div>
                            <div class="flex gap-2 mb-3">
                                ${story.has_image ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">ğŸ“· ç”»åƒ</span>' : ''}
                                ${story.has_audio ? '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">ğŸ¤ éŸ³å£°</span>' : ''}
                            </div>
                        </div>
                    </div>
                    ${memoryTextHtml}
                    ${imageHtml}
                    <div class="story-text text-gray-700 leading-relaxed">
                        ${story.story.substring(0, 200)}${story.story.length > 200 ? '...' : ''}
                    </div>
                    ${buttonHtml}
                </div>
            `}).join('');
        }

        function showFullStory(storyId) {
            // ã“ã®æ©Ÿèƒ½ã¯Pythonã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ãŒå¿…è¦ãªãŸã‚ã€GitHub Pagesä¸Šã§ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚
            // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å®Ÿè¡Œã—ãŸå ´åˆã«ã®ã¿æ©Ÿèƒ½ã—ã¾ã™ã€‚
            const story = allStories.find(s => s.id === storyId);
            if (!story) {
                alert('ç‰©èªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã“ã®æ©Ÿèƒ½ã¯ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ãŠè©¦ã—ãã ã•ã„ã€‚');
                return;
            }

            // ã€Œæ–°ã—ã„ç‰©èªã‚’ä½œã‚‹ã€ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
            showTab('create');

            // ãƒ•ã‚©ãƒ¼ãƒ ã¨å‡ºåŠ›ã‚¨ãƒªã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ/è¨­å®š
            document.getElementById("memoryInput").value = story.memory_text || '';
            document.getElementById("storyText").textContent = story.story;
            document.getElementById("continuationText").textContent = '';
            document.getElementById("continuationSection").classList.add("hidden");
            document.getElementById("audioPreview").classList.add("hidden");
            document.getElementById("imagePreview").classList.add("hidden");
            uploadedImageData = null;
            recordedAudioData = null;

            // æŠ½å‡ºã•ã‚ŒãŸè¨˜æ†¶ã‚’è¡¨ç¤º (ã‚ã‚Œã°)
            const extractedMemory = document.getElementById("extractedMemory");
            if (story.extracted_memory) {
                document.getElementById("extractedMemoryText").textContent = story.extracted_memory;
                extractedMemory.classList.remove("hidden");
            } else {
                extractedMemory.classList.add("hidden");
            }

            // å„ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            currentStoryId = story.id;
            document.getElementById("playStoryBtn").classList.remove("hidden");
            document.getElementById("continueStoryBtn").classList.remove("hidden");

            // ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // éŸ³å£°éŒ²éŸ³æ©Ÿèƒ½
        function setupAudioRecording() {
            document.getElementById("recordBtn").addEventListener("click", async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        
                        const recordedAudio = document.getElementById("recordedAudio");
                        const audioPreview = document.getElementById("audioPreview");
                        
                        recordedAudio.src = audioUrl;
                        audioPreview.classList.remove("hidden");

                        const reader = new FileReader();
                        reader.onloadend = () => {
                            recordedAudioData = reader.result;
                        };
                        reader.readAsDataURL(audioBlob);
                    };

                    mediaRecorder.start();
                    
                    document.getElementById("recordBtn").disabled = true;
                    document.getElementById("stopRecordBtn").disabled = false;
                    document.getElementById("recordingStatus").textContent = "ğŸ”´ éŒ²éŸ³ä¸­...";
                } catch (error) {
                    alert("ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚");
                }
            });

            document.getElementById("stopRecordBtn").addEventListener("click", () => {
                if (mediaRecorder && mediaRecorder.state === "recording") {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    
                    document.getElementById("recordBtn").disabled = false;
                    document.getElementById("stopRecordBtn").disabled = true;
                    document.getElementById("recordingStatus").textContent = "âœ… éŒ²éŸ³å®Œäº†";
                }
            });
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function setupImageUpload() {
            const imageInput = document.getElementById("imageInput");
            const previewImg = document.getElementById("previewImg");
            const imagePreview = document.getElementById("imagePreview");

            imageInput.addEventListener("change", () => {
                const file = imageInput.files[0];
                if (!file) {
                    uploadedImageData = null;
                    imagePreview.classList.add("hidden");
                    return;
                }

                const reader = new FileReader();
                reader.onloadend = () => {
                    // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    uploadedImageData = reader.result;
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
                    previewImg.src = uploadedImageData;
                    imagePreview.classList.remove("hidden");
                    showEncouragementMessage("ç´ æ•µãªå†™çœŸã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ“·");
                };
                reader.readAsDataURL(file);
            });
        }

        // ç‰©èªç”Ÿæˆæ©Ÿèƒ½
        function setupStoryGeneration() {
            document.getElementById("generateStoryBtn").addEventListener("click", generateStory);
            
            document.getElementById("playStoryBtn").addEventListener("click", playStory);
            
            document.getElementById("continueStoryBtn").addEventListener("click", () => {
                document.getElementById("continuationSection").classList.remove("hidden");
            });

            document.querySelectorAll(".continuation-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    generateContinuation(btn.dataset.type);
                });
            });
        }

        async function generateStory() {
            const memoryInput = document.getElementById("memoryInput").value;
            const storyText = document.getElementById("storyText");
            const loadingIndicator = document.getElementById("loadingIndicator");
            const extractedMemory = document.getElementById("extractedMemory");
            const extractedMemoryText = document.getElementById("extractedMemoryText");
            const playStoryBtn = document.getElementById("playStoryBtn");
            const continueStoryBtn = document.getElementById("continueStoryBtn");

            if (!memoryInput.trim() && !recordedAudioData) {
                alert("è¨˜æ†¶ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€éŸ³å£°ã‚’éŒ²éŸ³ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            storyText.textContent = "";
            extractedMemory.classList.add("hidden");
            playStoryBtn.classList.add("hidden");
            continueStoryBtn.classList.add("hidden");
            document.getElementById("continuationSection").classList.add("hidden");
            loadingIndicator.classList.remove("hidden");

            try {
                const requestData = {
                    category: selectedCategory
                };

                if (memoryInput.trim()) {
                    requestData.memory_text = memoryInput;
                }

                if (uploadedImageData) {
                    requestData.image_data = uploadedImageData;
                }

                if (recordedAudioData) {
                    requestData.audio_data = recordedAudioData;
                }

                const response = await fetch("/api/generate_story", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(requestData),
                });

                const data = await response.json();

                if (response.ok) {
                    storyText.textContent = data.story;
                    currentStoryId = data.story_id;
                    playStoryBtn.classList.remove("hidden");
                    continueStoryBtn.classList.remove("hidden");
                    
                    if (data.extracted_memory) {
                        extractedMemoryText.textContent = data.extracted_memory;
                        extractedMemory.classList.remove("hidden");
                    }

                    // åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    const randomMessage = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
                    showEncouragementMessage(randomMessage);

                    // ç‰©èªæ•°ã‚’æ›´æ–°
                    loadStoryCount();
                } else {
                    storyText.textContent = `ã‚¨ãƒ©ãƒ¼: ${data.error || "ç‰©èªã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"}`;
                }
            } catch (error) {
                storyText.textContent = `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            } finally {
                loadingIndicator.classList.add("hidden");
            }
        }

        async function generateContinuation(type) {
            if (!currentStoryId) {
                alert("ç‰©èªã‚’å…ˆã«ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const continuationText = document.getElementById("continuationText");
            continuationText.textContent = "ç¶šãã‚’ç”Ÿæˆä¸­...";

            try {
                const response = await fetch("/api/continue_story", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        story_id: currentStoryId,
                        type: type
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    continuationText.textContent = data.continuation;
                } else {
                    continuationText.textContent = `ã‚¨ãƒ©ãƒ¼: ${data.error}`;
                }
            } catch (error) {
                continuationText.textContent = `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        async function playStory() {
            const storyText = document.getElementById("storyText").textContent;
            const audioPlayer = document.getElementById("audioPlayer");
            const storyAudio = document.getElementById("storyAudio");

            if (!storyText) {
                alert("å†ç”Ÿã™ã‚‹ç‰©èªãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            try {
                const response = await fetch("/api/text_to_speech", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ text: storyText }),
                });

                const data = await response.json();

                if (response.ok) {
                    storyAudio.src = data.audio_url;
                    audioPlayer.classList.remove("hidden");
                    storyAudio.play();
                } else {
                    alert(`éŸ³å£°ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${data.error}`);
                }
            } catch (error) {
                alert(`é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function showEncouragementMessage(message) {
            const messageDiv = document.getElementById("encouragementMessage");
            const textDiv = document.getElementById("encouragementText");
            
            textDiv.textContent = message;
            messageDiv.classList.remove("hidden");
            
            setTimeout(() => {
                messageDiv.classList.add("hidden");
            }, 5000);
        }
    </script>
</body>
</html>
